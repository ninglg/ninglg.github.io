<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="width=device-width" data-next-head=""/><title data-next-head="">Light Up The World</title><link rel="preload" href="/_next/static/css/c6cf52e305c0a82d.css" as="style"/><link rel="preload" href="/_next/static/css/9bf84eca7195667a.css" as="style"/><link rel="stylesheet" href="/_next/static/css/c6cf52e305c0a82d.css" data-n-g=""/><link rel="stylesheet" href="/_next/static/css/9bf84eca7195667a.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" noModule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-8cac0b4b405cede1.js" defer=""></script><script src="/_next/static/chunks/framework-7c47d0879e3fabaa.js" defer=""></script><script src="/_next/static/chunks/main-eabf4e641ff2595a.js" defer=""></script><script src="/_next/static/chunks/pages/_app-1c3b0aeaafcae3ac.js" defer=""></script><script src="/_next/static/chunks/255-556050becd2e6a51.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-6464eaa07d778f00.js" defer=""></script><script src="/_next/static/ZTuZ-BdkL8qiSiHjBb1Ge/_buildManifest.js" defer=""></script><script src="/_next/static/ZTuZ-BdkL8qiSiHjBb1Ge/_ssgManifest.js" defer=""></script></head><body class="antialiased"><div id="__next"><div class="Post_container__ictJu"><nav class="Nav_nav__o8sSc"><div class="Nav_navContainer__KuO9f"><a class="Nav_navLogo__aczrM" href="/">Light Ning</a><div class="Nav_navLinks__sb_3K"><a class="Nav_navLink__z2PDT " href="/">首页</a><a class="Nav_navLink__z2PDT " href="/about">关于</a></div></div></nav><main class="Post_main__X4Tic"><article class="Post_post__1KH4p"><h1 class="Post_title__pen_7">微服务设计</h1><time class="Post_date__YGL_Q">2017-07-20</time><div class="Post_postTags__df1Jm"><span class="Post_postTag__j37er">微服务</span></div><div class="Post_content__aWM2C"><p>此篇是早前《微服务设计》的读书笔记，在此记录一下。</p>
<!-- more -->
<h2>微服务</h2>
<p>微服务就是一些协同工作的小而自治的服务。</p>
<ul>
<li>每个服务都很小，专注于做好一件事。</li>
<li>服务之间均通过网络调用进行通信，从而加强了服务之间的隔离性，避免紧耦合。</li>
</ul>
<h3>微服务的好处</h3>
<ul>
<li>技术异构性</li>
<li>弹性</li>
<li>扩展</li>
<li>简化部署</li>
<li>与组织结构相匹配</li>
<li>可组合性</li>
<li>对可替代性的优化</li>
</ul>
<p><strong>没有银弹！</strong> 为了得到微服务的好处，需要在部署、测试和监控方面做很多的工作，还需要考虑如何扩展系统，并且保证它们的弹性，也还需要处理分布式事务或者与CAP相关的问题。</p>
<p>很多组织采用微服务是为了使团队的自治性最大化。</p>
<h2>演进式架构师</h2>
<ul>
<li>愿景、同理心、合作</li>
<li>保证该系统适合开发人员在其上工作</li>
<li>从更高的层次出发，理解如何做权衡</li>
<li>治理和监督</li>
</ul>
<h2>如何建模服务</h2>
<h3>好服务的标准</h3>
<ul>
<li>高内聚</li>
<li>低耦合</li>
</ul>
<h2>集成</h2>
<h3>微服务之间通信方式的选择非常多样化</h3>
<ul>
<li>SOAP</li>
<li>XML-RPC</li>
<li>REST</li>
<li>Protocol Buffers</li>
<li>Thrift</li>
</ul>
<h3>本地调用和远程调用并不相同</h3>
<ul>
<li>RPC的核心想法是隐藏远程调用的复杂性。使用本地调用不会引起性能问题，但是RPC会花大量的时间对负荷进行封装和解封装，更别提网络通信所需要的时间。</li>
<li>需要注意的是，HTTP也可以用来实现RPC。比如SOAP就是基于HTTP进行路由的，但不幸的是它只用到HTTP很少的特性，而动词和HTTP的错误码都被忽略了。</li>
<li>通过HTTP我们可以发送任何格式，甚至是二进制的。</li>
</ul>
<h3>实现基于事件的异步协作方式</h3>
<h3>服务即状态机</h3>
<h3>使用语义化的版本管理</h3>
<ul>
<li>MAJOR.MINOR.PATCH</li>
<li>短期内同时使用两个版本的服务是合理的，尤其是当你做蓝绿部署或者金丝雀发布时</li>
</ul>
<h3>API组合</h3>
<p>使用API入口（gateway）可以缓解移动设备与服务过多通信的问题，在这种模式下多个底层的调用会被聚合成为一个调用，当然它也有一定的局限性。</p>
<h2>分解单块系统</h2>
<ul>
<li>最好考虑把哪部分代码抽取出去得到的收益最大，而不是为了抽取而抽取</li>
<li>想要抽取出来的接口应该尽量少的被其它组件所依赖</li>
<li>先分离数据库，再对服务进行分离</li>
<li>重试保证最终一致性</li>
<li>补偿事务</li>
<li>分布式事务，事务管理器</li>
</ul>
<h2>部署</h2>
<h3>真正理解CI的三个问题</h3>
<ol>
<li>每天签入代码到主干</li>
<li>有一组测试来验证修改</li>
<li>把修复CI当做第一优先级的事情来做</li>
</ol>
<h3>平台即服务</h3>
<p>PaaS（Platform-as-a-Service）</p>
<h3>传统的虚拟化技术</h3>
<p>采用标准虚拟化的如AWS、VMWare、VSphere、Xen和KVM等。</p>
<h3>基于轻量级容器的虚拟化（LXC）</h3>
<p>Docker</p>
<h2>测试</h2>
<h3>单元测试</h3>
<p>TDD：Test-Driven Development，测试驱动开发</p>
<h3>Mock还是打桩</h3>
<h3>金丝雀发布</h3>
<ul>
<li>金丝雀发布是指通过将部分生产流量引流到新部署的系统，来验证系统是否按预期执行。</li>
<li>金丝雀发布与蓝/绿发布的不同之处在于，新旧版本共存的时间更长，而且经常会调整流量。</li>
<li>Netflix广泛采用金丝雀发布的方式，通过对比新版本与基线版本的分数，只有当新版本分数更高时，才会全面部署新版本到生产环境。</li>
</ul>
<h3>平均修复时间胜过平均故障间隔时间</h3>
<ul>
<li>平均故障间隔时间（MTBF，Mean Time Between Failures）</li>
<li>平均修复时间（MTTR，Mean Time To Repaire）</li>
</ul>
<h2>监控</h2>
<p>监控小的服务，然后聚合起来看整体。</p>
<h2>安全</h2>
<ul>
<li>单点登录SSO（Single Sign-On）</li>
<li>HTTPS基本身份验证</li>
<li>客户端证书TLS（Transport Layer Security，安全传输层协议）</li>
<li>API秘钥
不要实现自己的加密算法，不要发明自己的安全协议。</li>
</ul>
<h2>康威定律与系统设计</h2>
<ul>
<li>组织和架构应该一致，信奉这个理念的两个典范是Amazon和Netflix。</li>
<li>每条业务线团队，负责自己创建的服务的整个生命周期，包括构建、测试、发布和运维，甚至弃用。</li>
</ul>
<h2>规模化微服务</h2>
<p>当微服务的数量比人还多时，有什么应对的模式吗？</p>
<ul>
<li>故障无处不在
除了使用流程和控制来试图阻止故障的发生外，更应该思考如何更加容易的在第一时间从故障中恢复过来。</li>
<li>功能降级</li>
<li>年度DiRT（Disaster Recovery Test，灾难恢复测试）</li>
<li>超时、断路器</li>
<li>幂等</li>
<li>CQRS（Command-Query Responsibility Segregation，命令查询职责分离）模式，是一个存储和查询信息的替代模型。</li>
</ul>
<h3>缓存</h3>
<ul>
<li>客户端、代理和服务器端缓存</li>
<li>HTTP缓存：</li>
</ul>
<ol>
<li>cache-control</li>
<li>expires</li>
<li>etag（entity tags）</li>
</ol>
<h2>CAP定理</h2>
<p>在分布式系统中，需要有三方面进行权衡：</p>
<ol>
<li>一致性（consistency）</li>
<li>可用性（availability）</li>
<li>分区容忍性（partition tolerance）
如果系统没有分区容忍性，就不能跨网络运行。换句话说，需要在本地运行一个单独的进程。所以，CA系统在分布式系统中根本是不存在的。选择AP还是CP，在现实中要视情况而定。</li>
</ol>
<h2>服务发现</h2>
<h2>动态服务注册</h2>
<ul>
<li>Zookeeper</li>
<li>Consul</li>
</ul>
<h2>总结</h2>
<ul>
<li>围绕业务概念建模</li>
<li>接受自动化文化</li>
<li>隐藏内部实现细节</li>
</ul>
</div></article><div class="Post_postNavigation__TSrfz"><a class="Post_navLink__iyGDb" href="/posts/docker-intro">← <!-- -->Docker原理介绍</a><a class="Post_navLink__iyGDb Post_nextLink__THXHn" href="/posts/iron-man">钢铁侠<!-- --> →</a></div></main><footer class="footer_footer__mqdak"><p>Copyright © <!-- -->2025<!-- --> <!-- -->Light Ning<!-- -->. All rights reserved.</p></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"summary":null,"tags":["微服务"],"id":"building-microservices","contentHtml":"\u003cp\u003e此篇是早前《微服务设计》的读书笔记，在此记录一下。\u003c/p\u003e\n\u003c!-- more --\u003e\n\u003ch2\u003e微服务\u003c/h2\u003e\n\u003cp\u003e微服务就是一些协同工作的小而自治的服务。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e每个服务都很小，专注于做好一件事。\u003c/li\u003e\n\u003cli\u003e服务之间均通过网络调用进行通信，从而加强了服务之间的隔离性，避免紧耦合。\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003e微服务的好处\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e技术异构性\u003c/li\u003e\n\u003cli\u003e弹性\u003c/li\u003e\n\u003cli\u003e扩展\u003c/li\u003e\n\u003cli\u003e简化部署\u003c/li\u003e\n\u003cli\u003e与组织结构相匹配\u003c/li\u003e\n\u003cli\u003e可组合性\u003c/li\u003e\n\u003cli\u003e对可替代性的优化\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e没有银弹！\u003c/strong\u003e 为了得到微服务的好处，需要在部署、测试和监控方面做很多的工作，还需要考虑如何扩展系统，并且保证它们的弹性，也还需要处理分布式事务或者与CAP相关的问题。\u003c/p\u003e\n\u003cp\u003e很多组织采用微服务是为了使团队的自治性最大化。\u003c/p\u003e\n\u003ch2\u003e演进式架构师\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e愿景、同理心、合作\u003c/li\u003e\n\u003cli\u003e保证该系统适合开发人员在其上工作\u003c/li\u003e\n\u003cli\u003e从更高的层次出发，理解如何做权衡\u003c/li\u003e\n\u003cli\u003e治理和监督\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003e如何建模服务\u003c/h2\u003e\n\u003ch3\u003e好服务的标准\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e高内聚\u003c/li\u003e\n\u003cli\u003e低耦合\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003e集成\u003c/h2\u003e\n\u003ch3\u003e微服务之间通信方式的选择非常多样化\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eSOAP\u003c/li\u003e\n\u003cli\u003eXML-RPC\u003c/li\u003e\n\u003cli\u003eREST\u003c/li\u003e\n\u003cli\u003eProtocol Buffers\u003c/li\u003e\n\u003cli\u003eThrift\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003e本地调用和远程调用并不相同\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eRPC的核心想法是隐藏远程调用的复杂性。使用本地调用不会引起性能问题，但是RPC会花大量的时间对负荷进行封装和解封装，更别提网络通信所需要的时间。\u003c/li\u003e\n\u003cli\u003e需要注意的是，HTTP也可以用来实现RPC。比如SOAP就是基于HTTP进行路由的，但不幸的是它只用到HTTP很少的特性，而动词和HTTP的错误码都被忽略了。\u003c/li\u003e\n\u003cli\u003e通过HTTP我们可以发送任何格式，甚至是二进制的。\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003e实现基于事件的异步协作方式\u003c/h3\u003e\n\u003ch3\u003e服务即状态机\u003c/h3\u003e\n\u003ch3\u003e使用语义化的版本管理\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eMAJOR.MINOR.PATCH\u003c/li\u003e\n\u003cli\u003e短期内同时使用两个版本的服务是合理的，尤其是当你做蓝绿部署或者金丝雀发布时\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003eAPI组合\u003c/h3\u003e\n\u003cp\u003e使用API入口（gateway）可以缓解移动设备与服务过多通信的问题，在这种模式下多个底层的调用会被聚合成为一个调用，当然它也有一定的局限性。\u003c/p\u003e\n\u003ch2\u003e分解单块系统\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e最好考虑把哪部分代码抽取出去得到的收益最大，而不是为了抽取而抽取\u003c/li\u003e\n\u003cli\u003e想要抽取出来的接口应该尽量少的被其它组件所依赖\u003c/li\u003e\n\u003cli\u003e先分离数据库，再对服务进行分离\u003c/li\u003e\n\u003cli\u003e重试保证最终一致性\u003c/li\u003e\n\u003cli\u003e补偿事务\u003c/li\u003e\n\u003cli\u003e分布式事务，事务管理器\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003e部署\u003c/h2\u003e\n\u003ch3\u003e真正理解CI的三个问题\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e每天签入代码到主干\u003c/li\u003e\n\u003cli\u003e有一组测试来验证修改\u003c/li\u003e\n\u003cli\u003e把修复CI当做第一优先级的事情来做\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3\u003e平台即服务\u003c/h3\u003e\n\u003cp\u003ePaaS（Platform-as-a-Service）\u003c/p\u003e\n\u003ch3\u003e传统的虚拟化技术\u003c/h3\u003e\n\u003cp\u003e采用标准虚拟化的如AWS、VMWare、VSphere、Xen和KVM等。\u003c/p\u003e\n\u003ch3\u003e基于轻量级容器的虚拟化（LXC）\u003c/h3\u003e\n\u003cp\u003eDocker\u003c/p\u003e\n\u003ch2\u003e测试\u003c/h2\u003e\n\u003ch3\u003e单元测试\u003c/h3\u003e\n\u003cp\u003eTDD：Test-Driven Development，测试驱动开发\u003c/p\u003e\n\u003ch3\u003eMock还是打桩\u003c/h3\u003e\n\u003ch3\u003e金丝雀发布\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e金丝雀发布是指通过将部分生产流量引流到新部署的系统，来验证系统是否按预期执行。\u003c/li\u003e\n\u003cli\u003e金丝雀发布与蓝/绿发布的不同之处在于，新旧版本共存的时间更长，而且经常会调整流量。\u003c/li\u003e\n\u003cli\u003eNetflix广泛采用金丝雀发布的方式，通过对比新版本与基线版本的分数，只有当新版本分数更高时，才会全面部署新版本到生产环境。\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003e平均修复时间胜过平均故障间隔时间\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e平均故障间隔时间（MTBF，Mean Time Between Failures）\u003c/li\u003e\n\u003cli\u003e平均修复时间（MTTR，Mean Time To Repaire）\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003e监控\u003c/h2\u003e\n\u003cp\u003e监控小的服务，然后聚合起来看整体。\u003c/p\u003e\n\u003ch2\u003e安全\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e单点登录SSO（Single Sign-On）\u003c/li\u003e\n\u003cli\u003eHTTPS基本身份验证\u003c/li\u003e\n\u003cli\u003e客户端证书TLS（Transport Layer Security，安全传输层协议）\u003c/li\u003e\n\u003cli\u003eAPI秘钥\n不要实现自己的加密算法，不要发明自己的安全协议。\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003e康威定律与系统设计\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e组织和架构应该一致，信奉这个理念的两个典范是Amazon和Netflix。\u003c/li\u003e\n\u003cli\u003e每条业务线团队，负责自己创建的服务的整个生命周期，包括构建、测试、发布和运维，甚至弃用。\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003e规模化微服务\u003c/h2\u003e\n\u003cp\u003e当微服务的数量比人还多时，有什么应对的模式吗？\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e故障无处不在\n除了使用流程和控制来试图阻止故障的发生外，更应该思考如何更加容易的在第一时间从故障中恢复过来。\u003c/li\u003e\n\u003cli\u003e功能降级\u003c/li\u003e\n\u003cli\u003e年度DiRT（Disaster Recovery Test，灾难恢复测试）\u003c/li\u003e\n\u003cli\u003e超时、断路器\u003c/li\u003e\n\u003cli\u003e幂等\u003c/li\u003e\n\u003cli\u003eCQRS（Command-Query Responsibility Segregation，命令查询职责分离）模式，是一个存储和查询信息的替代模型。\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003e缓存\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e客户端、代理和服务器端缓存\u003c/li\u003e\n\u003cli\u003eHTTP缓存：\u003c/li\u003e\n\u003c/ul\u003e\n\u003col\u003e\n\u003cli\u003ecache-control\u003c/li\u003e\n\u003cli\u003eexpires\u003c/li\u003e\n\u003cli\u003eetag（entity tags）\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2\u003eCAP定理\u003c/h2\u003e\n\u003cp\u003e在分布式系统中，需要有三方面进行权衡：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e一致性（consistency）\u003c/li\u003e\n\u003cli\u003e可用性（availability）\u003c/li\u003e\n\u003cli\u003e分区容忍性（partition tolerance）\n如果系统没有分区容忍性，就不能跨网络运行。换句话说，需要在本地运行一个单独的进程。所以，CA系统在分布式系统中根本是不存在的。选择AP还是CP，在现实中要视情况而定。\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2\u003e服务发现\u003c/h2\u003e\n\u003ch2\u003e动态服务注册\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eZookeeper\u003c/li\u003e\n\u003cli\u003eConsul\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003e总结\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e围绕业务概念建模\u003c/li\u003e\n\u003cli\u003e接受自动化文化\u003c/li\u003e\n\u003cli\u003e隐藏内部实现细节\u003c/li\u003e\n\u003c/ul\u003e\n","date":"2017-07-20T00:00:00.000Z","title":"微服务设计"},"prevPost":{"summary":null,"tags":["Docker"],"id":"docker-intro","title":"Docker原理介绍","date":"2017-07-22T00:00:00.000Z"},"nextPost":{"summary":null,"tags":["电影"],"id":"iron-man","title":"钢铁侠","date":"2017-06-27T00:00:00.000Z"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"building-microservices"},"buildId":"ZTuZ-BdkL8qiSiHjBb1Ge","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>