{"pageProps":{"post":{"summary":null,"tags":["算法"],"id":"rate-limit-algorithm-intro","contentHtml":"<p>此篇介绍一下常见的几种限流算法。</p>\n<h1>问题背景</h1>\n<p>在突发流量增长的情况下，由于系统准备不足，很难通过短期扩容来应对 。此时，进行限流是最常用的手段，限流也是服务稳定性治理重要的手段之一。</p>\n<h1>限流的发生</h1>\n<p>限流可能发生在多个层面：</p>\n<ol>\n<li>用户网络层：突发的流量场景如热点事件流量（秒杀事件、热门抢购，微博热搜），恶意刷流，竞对爬虫等。</li>\n<li>内部应用层：上游服务的异常调用，脚本异常请求，失败重试策略造成流量突发。</li>\n</ol>\n<h1>实现限流的方案</h1>\n<p>常用的限流方法主要有三种：计数器算法（或类似滑动窗口），漏斗桶算法，令牌桶算法。</p>\n<h2>计数器算法</h2>\n<ol>\n<li>单机限流：使用全局内存计数</li>\n<li>分布式系统限流：使用redis等公共存储计数，用incr可以保障原子性操作。</li>\n</ol>\n<blockquote>\n<p>注意使用固定窗口还是滑动窗口优化的问题。</p>\n</blockquote>\n<h2>漏斗桶算法</h2>\n<ol>\n<li>Uber提供了基于漏斗桶的算法实现可以参考：https://github.com/uber-go/ratelimit</li>\n<li>redis4.0提供了限流模块，redis-cell。该模块使用漏斗算法，并提供原子限流指令。</li>\n</ol>\n<blockquote>\n<p>漏斗桶更像是对流量进行整形Traffic Shaping，所有流量过来都要进行排队，依次出去，可用于做一些论坛博客发帖频率限制。\n由于出口处理速率是匀速的，短时有大量突发请求，即使负载压力不大，请求仍需要在队列等待处理。</p>\n</blockquote>\n<h2>令牌桶算法</h2>\n<ol>\n<li>当访问量小时，令牌桶可以积累令牌到桶满，而当短时突发流量，积累的令牌能保障大量请求可以立刻拿到令牌，令牌用完了，请求会依赖于新令牌申请速度，这时会退化成类似漏斗桶算法。</li>\n<li>具体实现上可以使用redis的list，启动任务向list匀速放置数据，当有请求时从list取数据，取到代表通过，否则被限流。这么实现有个弊端，就是需要不断操作list，浪费内存空间，实际上可以使用实时算法计算的方式来计算可用令牌数。</li>\n<li>还有更多可实现细节如预热桶、一次性放入多个令牌、一次性取多个令牌。同时由于原子性问题，通过redis+lua脚本操作（lua实现令牌桶）会更好。</li>\n<li>令牌桶既能够将所有请求平均分布到时间区间内，又能接受突发请求，因此是使用最广泛的限流算法。</li>\n</ol>\n<h1>部署方式</h1>\n<ol>\n<li>集中部署统一的限流中心</li>\n<li>限流部署在接入层</li>\n<li>服务中心与单机限流结合</li>\n</ol>\n<h1>限流配置</h1>\n<ol>\n<li>接口粒度</li>\n<li>时间粒度</li>\n<li>最大限流数</li>\n</ol>\n<h1>命中限流后的处理</h1>\n<ol>\n<li>限流后处理方式可以做服务降级（返回默认值、默认页面）、请求丢弃（拒绝请求）、请求排队（阻塞请求）、发送报警人工介入处理等。</li>\n<li>也有直接结合服务降级熔断的如Sentinel、Hystrix。</li>\n</ol>\n","date":"2018-01-23T22:24:19.000Z","title":"常见限流算法介绍","published":true,"hideInList":false,"feature":null,"isTop":false},"prevPost":{"summary":null,"tags":["MySQL"],"id":"mysql-develop-guideline","title":"MySQL开发规范","date":"2018-01-31T19:29:38.000Z","published":true,"hideInList":false,"feature":null,"isTop":false},"nextPost":{"summary":null,"tags":["Redis"],"id":"redis-cluster-solution","title":"Redis集群方案介绍","date":"2018-01-18T10:00:00.000Z","published":true,"hideInList":false,"feature":null,"isTop":false}},"__N_SSG":true}